/*******************************************************************************
  @file     equalizer.c
  @brief    Equalizer por song effects.
  @author   Grupo 4 Laboratorio de Microprocesadores:
  	  	  	Corcos, Manuel
  	  	  	Lesiuk, Alejandro
  	  	  	Paget, Milagros
  	  	  	Voss, Maria de Guadalupe
 ******************************************************************************/

#include "math_helper.h"
#include "equalizer.h"
#include <stdint.h>
#include <stdio.h>

/*******************************************************************************
 * STATIC VARIABLES AND CONST VARIABLES WITH FILE LEVEL SCOPE
 ******************************************************************************/

/* ----------------------------------------------------------------------
** Arm Biquad cascade filters for each band
** ------------------------------------------------------------------- */
static arm_biquad_cas_df1_32x64_ins_q31 S1;
static arm_biquad_cas_df1_32x64_ins_q31 S2;
static arm_biquad_casd_df1_inst_q31 S3;
static arm_biquad_casd_df1_inst_q31 S4;
static arm_biquad_casd_df1_inst_q31 S5;
static arm_biquad_casd_df1_inst_q31 S6;
static arm_biquad_casd_df1_inst_q31 S7;
static arm_biquad_casd_df1_inst_q31 S8;

static arm_biquad_cas_df1_32x64_ins_q31 * Low_Filters [2] = {&S1, &S2};
static arm_biquad_casd_df1_inst_q31 * High_Filters [6] = {&S3, &S4, &S5, &S6, &S7, &S8};

/* ----------------------------------------------------------------------
** Q31 state buffers for Band1, Band2, Band3, Band4, Band5, Band6, Band7 and Band8
** ------------------------------------------------------------------- */

static q63_t biquadStateBandQ63 [2][4 * 2];
static q31_t biquadStateBandQ31 [6][4 * 2];
static int32_t bandGains[NUMBER_OF_BANDS]={DEFAULT_GAIN, DEFAULT_GAIN, DEFAULT_GAIN, DEFAULT_GAIN, DEFAULT_GAIN, DEFAULT_GAIN, DEFAULT_GAIN, DEFAULT_GAIN, };


/* ----------------------------------------------------------------------
** Entire coefficient table.  There are 10 coefficients per 4th order Biquad
** cascade filter.  The first 10 coefficients correspond to the -10 dB gain
** setting of band 1; the next 10 coefficient correspond to the -9 dB gain
** setting of band 1; and so on.  There are 10*21=210 coefficients in total
** for band 1 (gains = -10,...0,...10).  After this come the 210 coefficients
** for band 2.
**
** The coefficients are in Q31 format
** ------------------------------------------------------------------- */

static const q31_t coeffTable[NUMBER_OF_BANDS * COEF_PER_FILTER * GAIN_LEVELS] = {

		/* 80Hz band*/
		536870912,-1071816922,535036912,1070077802,-533319196,536870912,-1072283112,535465554,1071497458,-534669630,	// -10 dB Gain
		536870912,-1071693559,534915004,1070077802,-533319196,536870912,-1072214251,535395843,1071497458,-534669630,
		536870912,-1071561253,534784268,1070077802,-533319196,536870912,-1072142943,535323648,1071497458,-534669630,
		536870912,-1071419276,534643986,1070077802,-533319196,536870912,-1072069242,535249022,1071497458,-534669630,
		536870912,-1071266834,534493379,1070077802,-533319196,536870912,-1071993226,535172041,1071497458,-534669630,
		536870912,-1071103061,534331592,1070077802,-533319196,536870912,-1071915005,535092816,1071497458,-534669630,
		536870912,-1070927009,534157695,1070077802,-533319196,536870912,-1071834725,535011491,1071497458,-534669630,
		536870912,-1070737643,533970671,1070077802,-533319196,536870912,-1071752571,534928251,1071497458,-534669630,
		536870912,-1070533830,533769407,1070077802,-533319196,536870912,-1071668776,534843329,1071497458,-534669630,
		536870912,-1070314334,533552691,1070077802,-533319196,536870912,-1071583624,534757007,1071497458,-534669630,
		536870912,0,0,0,0,536870912,0,0,0,0,																			// 0 dB Gain
		536870912,-1069822755,533067475,1070077802,-533319196,536870912,-1071410687,534581606,1071497458,-534669630,
		536870912,-1069547581,532795951,1070077802,-533319196,536870912,-1071323791,534493417,1071497458,-534669630,
		536870912,-1069250518,532502903,1070077802,-533319196,536870912,-1071237333,534405625,1071497458,-534669630,
		536870912,-1068929649,532186461,1070077802,-533319196,536870912,-1071151958,534318877,1071497458,-534669630,
		536870912,-1068582892,531844599,1070077802,-533319196,536870912,-1071068404,534233912,1071497458,-534669630,
		536870912,-1068207990,531475124,1070077802,-533319196,536870912,-1070987501,534151562,1071497458,-534669630,
		536870912,-1067802507,531075675,1070077802,-533319196,536870912,-1070910175,534072756,1071497458,-534669630,
		536870912,-1067363831,530643725,1070077802,-533319196,536870912,-1070837440,533998512,1071497458,-534669630,
		536870912,-1066889171,530176588,1070077802,-533319196,536870912,-1070770392,533929929,1071497458,-534669630,
		536870912,-1066375577,529671429,1070077802,-533319196,536870912,-1070710189,533868170,1071497458,-534669630,	// 10 dB Gain
		/* 160Hz band*/
		536870912,-1069717127,533209189,1066214306,-529791114,536870912,-1070721581,534063800,1069176170,-532477236,
		536870912,-1069468410,532966239,1066214306,-529791114,536870912,-1070585936,533924747,1069176170,-532477236,
		536870912,-1069201706,532705756,1066214306,-529791114,536870912,-1070445505,533780758,1069176170,-532477236,
		536870912,-1068915559,532426328,1066214306,-529791114,536870912,-1070300397,533631939,1069176170,-532477236,
		536870912,-1068608378,532126414,1066214306,-529791114,536870912,-1070150772,533478448,1069176170,-532477236,
		536870912,-1068278429,531804332,1066214306,-529791114,536870912,-1069996855,533320505,1069176170,-532477236,
		536870912,-1067923814,531458252,1066214306,-529791114,536870912,-1069838936,533158399,1069176170,-532477236,
		536870912,-1067542464,531086173,1066214306,-529791114,536870912,-1069677391,532992503,1069176170,-532477236,
		536870912,-1067132116,530685913,1066214306,-529791114,536870912,-1069512682,532823279,1069176170,-532477236,
		536870912,-1066690297,530255092,1066214306,-529791114,536870912,-1069345381,532651295,1069176170,-532477236,
		536870912,0,0,0,0,536870912,0,0,0,0,
		536870912,-1065701191,529291150,1066214306,-529791114,536870912,-1069005865,532301918,1069176170,-532477236,
		536870912,-1065147732,528752117,1066214306,-529791114,536870912,-1068835425,532126301,1069176170,-532477236,
		536870912,-1064550420,528170667,1066214306,-529791114,536870912,-1068665964,531951502,1069176170,-532477236,
		536870912,-1063905432,527543165,1066214306,-529791114,536870912,-1068498766,531778812,1069176170,-532477236,
		536870912,-1063208619,526865676,1066214306,-529791114,536870912,-1068335294,531609699,1069176170,-532477236,
		536870912,-1062455489,526133960,1066214306,-529791114,536870912,-1068177197,531445819,1069176170,-532477236,
		536870912,-1061641195,525343462,1066214306,-529791114,536870912,-1068026307,531289016,1069176170,-532477236,
		536870912,-1060760537,524489323,1066214306,-529791114,536870912,-1067884635,531141313,1069176170,-532477236,
		536870912,-1059807970,523566393,1066214306,-529791114,536870912,-1067754346,531004893,1069176170,-532477236,
		536870912,-1058777630,522569270,1066214306,-529791114,536870912,-1067637731,530882066,1069176170,-532477236,
		/* 320Hz band*/
		536870912,-1064996718,529572532,1057897898,-522805762,536870912,-1067291485,531270768,1064304322,-528118424,
		536870912,-1064491632,529090097,1057897898,-522805762,536870912,-1067028531,530994110,1064304322,-528118424,
		536870912,-1063950209,528573097,1057897898,-522805762,536870912,-1066756430,530707707,1064304322,-528118424,
		536870912,-1063369525,528018781,1057897898,-522805762,536870912,-1066475410,530411778,1064304322,-528118424,
		536870912,-1062746397,527424156,1057897898,-522805762,536870912,-1066185807,530106643,1064304322,-528118424,
		536870912,-1062077352,526785962,1057897898,-522805762,536870912,-1065888077,529792749,1064304322,-528118424,
		536870912,-1061358599,526100654,1057897898,-522805762,536870912,-1065582814,529470679,1064304322,-528118424,
		536870912,-1060586002,525364370,1057897898,-522805762,536870912,-1065270770,529141179,1064304322,-528118424,
		536870912,-1059755048,524572909,1057897898,-522805762,536870912,-1064952878,528805175,1064304322,-528118424,
		536870912,-1058860806,523721697,1057897898,-522805762,536870912,-1064630274,528463802,1064304322,-528118424,
		536870912,0,0,0,0,536870912,0,0,0,0,
		536870912,-1056860454,521819701,1057897898,-522805762,536870912,-1063976641,527770663,1064304322,-528118424,
		536870912,-1055742077,520757653,1057897898,-522805762,536870912,-1063649128,527422426,1064304322,-528118424,
		536870912,-1054535799,519613267,1057897898,-522805762,536870912,-1063323989,527075932,1064304322,-528118424,
		536870912,-1053234046,518379685,1057897898,-522805762,536870912,-1063003756,526733734,1064304322,-528118424,
		536870912,-1051828602,517049516,1057897898,-522805762,536870912,-1062691313,526398739,1064304322,-528118424,
		536870912,-1050310582,515614838,1057897898,-522805762,536870912,-1062389897,526074222,1064304322,-528118424,
		536870912,-1048670416,514067194,1057897898,-522805762,536870912,-1062103110,525763824,1064304322,-528118424,
		536870912,-1046897846,512397625,1057897898,-522805762,536870912,-1061834890,525471538,1064304322,-528118424,
		536870912,-1044981949,510596717,1057897898,-522805762,536870912,-1061589479,525201671,1064304322,-528118424,
		536870912,-1042911184,508654681,1057897898,-522805762,536870912,-1061371349,524958774,1064304322,-528118424,
		/* 640Hz band*/
		536870912,-1053500912,522374087,1038971236,-509117552,536870912,-1059213773,525724302,1053654553,-519500012,
		536870912,-1052462660,521423100,1038971236,-509117552,536870912,-1058721412,525176571,1053654553,-519500012,
		536870912,-1051350515,520404977,1038971236,-509117552,536870912,-1058212424,524609844,1053654553,-519500012,
		536870912,-1050158635,519314517,1038971236,-509117552,536870912,-1057687320,524024581,1053654553,-519500012,
		536870912,-1048880665,518146081,1038971236,-509117552,536870912,-1057146814,523421450,1053654553,-519500012,
		536870912,-1047509687,516893558,1038971236,-509117552,536870912,-1056591856,522801362,1053654553,-519500012,
		536870912,-1046038167,515550323,1038971236,-509117552,536870912,-1056023665,522165503,1053654553,-519500012,
		536870912,-1044457902,514109198,1038971236,-509117552,536870912,-1055443765,521515374,1053654553,-519500012,
		536870912,-1042759957,512562413,1038971236,-509117552,536870912,-1054854031,520852834,1053654553,-519500012,
		536870912,-1040934601,510901560,1038971236,-509117552,536870912,-1054256726,520180142,1053654553,-519500012,
		536870912,0,0,0,0,536870912,0,0,0,0,
		536870912,-1036858331,507200583,1038971236,-509117552,536870912,-1053050701,518815655,1053654553,-519500012,
		536870912,-1034583347,505140095,1038971236,-509117552,536870912,-1052448894,518130838,1053654553,-519500012,
		536870912,-1032132666,502924748,1038971236,-509117552,536870912,-1051853441,517449930,1053654553,-519500012,
		536870912,-1029491525,500542404,1038971236,-509117552,536870912,-1051269272,516777947,1053654553,-519500012,
		536870912,-1026643957,497980130,1038971236,-509117552,536870912,-1050701977,516120589,1053654553,-519500012,
		536870912,-1023572746,495224218,1038971236,-509117552,536870912,-1050157822,515484263,1053654553,-519500012,
		536870912,-1020259406,492260249,1038971236,-509117552,536870912,-1049643744,514876084,1053654553,-519500012,
		536870912,-1016684192,489073187,1038971236,-509117552,536870912,-1049167313,514303838,1053654553,-519500012,
		536870912,-1012826154,485647538,1038971236,-509117552,536870912,-1048736653,513775912,1053654553,-519500012,
		536870912,-1008663248,481967562,1038971236,-509117552,536870912,-1048360302,513301156,1053654553,-519500012,
		/* 1280Hz band*/
		536870912,-1022534048,508274418,992463053,-482863560,536870912,-1038283068,514771893,1028827019,-502624281,
		536870912,-1020365229,506428067,992463053,-482863560,536870912,-1037433905,513697201,1028827019,-502624281,
		536870912,-1018045662,504455396,992463053,-482863560,536870912,-1036557978,512586370,1028827019,-502624281,
		536870912,-1015563875,502347180,992463053,-482863560,536870912,-1035656480,511440424,1028827019,-502624281,
		536870912,-1012907442,500093503,992463053,-482863560,536870912,-1034730991,510260797,1028827019,-502624281,
		536870912,-1010062897,497683714,992463053,-482863560,536870912,-1033783536,509049396,1028827019,-502624281,
		536870912,-1007015652,495106381,992463053,-482863560,536870912,-1032816646,507808661,1028827019,-502624281,
		536870912,-1003749897,492349255,992463053,-482863560,536870912,-1031833426,506541647,1028827019,-502624281,
		536870912,-1000248503,489399227,992463053,-482863560,536870912,-1030837628,505252094,1028827019,-502624281,
		536870912,-996492917,486242298,992463053,-482863560,536870912,-1029833731,503944514,1028827019,-502624281,
		536870912,0,0,0,0,536870912,0,0,0,0,
		536870912,-988137184,479247181,992463053,-482863560,536870912,-1027823674,501297725,1028827019,-502624281,
		536870912,-983491836,475376419,992463053,-482863560,536870912,-1026830850,499972219,1028827019,-502624281,
		536870912,-978501683,471233660,992463053,-482863560,536870912,-1025856762,498656277,1028827019,-502624281,
		536870912,-973139465,466800484,992463053,-482863560,536870912,-1024910751,497359627,1028827019,-502624281,
		536870912,-967375916,462057790,992463053,-482863560,536870912,-1024003333,496093278,1028827019,-502624281,
		536870912,-961179739,456985968,992463053,-482863560,536870912,-1023146225,494869558,1028827019,-502624281,
		536870912,-954517618,451565152,992463053,-482863560,536870912,-1022352317,493702103,1028827019,-502624281,
		536870912,-947354305,445775569,992463053,-482863560,536870912,-1021635590,492605788,1028827019,-502624281,
		536870912,-939652797,439597987,992463053,-482863560,536870912,-1021010947,491596581,1028827019,-502624281,
		536870912,-931374623,433014295,992463053,-482863560,536870912,-1020493940,490691283,1028827019,-502624281,
		/* 2500Hz band*/
		536870912,-936047970,482479929,875686579,-436894827,536870912,-981563302,494290899,969273431,-471552808,
		536870912,-931608967,479081236,875686579,-436894827,536870912,-980416389,492258814,969273431,-471552808,
		536870912,-926876941,475465058,875686579,-436894827,536870912,-979240047,490162370,969273431,-471552808,
		536870912,-921831475,471617561,875686579,-436894827,536870912,-978037073,488003941,969273431,-471552808,
		536870912,-916450678,467524171,875686579,-436894827,536870912,-976810945,485786686,969273431,-471552808,
		536870912,-910711084,463169573,875686579,-436894827,536870912,-975565910,483514659,969273431,-471552808,
		536870912,-904587549,458537737,875686579,-436894827,536870912,-974307093,481192921,969273431,-471552808,
		536870912,-898053148,453611946,875686579,-436894827,536870912,-973040602,478827671,969273431,-471552808,
		536870912,-891079070,448374855,875686579,-436894827,536870912,-971773645,476426382,969273431,-471552808,
		536870912,-883634511,442808583,875686579,-436894827,536870912,-970514658,473997942,969273431,-471552808,
		536870912,0,0,0,0,536870912,0,0,0,0,
		536870912,-867200212,430615041,875686579,-436894827,536870912,-968061237,469103163,969273431,-471552808,
		536870912,-858138102,423950653,875686579,-436894827,536870912,-966890960,466663066,969273431,-471552808,
		536870912,-848460664,416883366,875686579,-436894827,536870912,-965777204,464248598,969273431,-471552808,
		536870912,-838126028,409395537,875686579,-436894827,536870912,-964736383,461877988,969273431,-471552808,
		536870912,-827090106,401470655,875686579,-436894827,536870912,-963786774,459571703,969273431,-471552808,
		536870912,-815306725,393093950,875686579,-436894827,536870912,-962948500,457352485,969273431,-471552808,
		536870912,-802727875,384253126,875686579,-436894827,536870912,-962243442,455245308,969273431,-471552808,
		536870912,-789304098,374939248,875686579,-436894827,536870912,-961695030,453277219,969273431,-471552808,
		536870912,-774985045,365147795,875686579,-436894827,536870912,-961327878,451477032,969273431,-471552808,
		536870912,-759720261,354879851,875686579,-436894827,536870912,-961167239,449874824,969273431,-471552808,
		/* 5000Hz band*/
		536870912,-666051300,434000610,553291775,-358845362,536870912,-805166254,453012617,805433442,-410709606,
		536870912,-657390917,428057120,553291775,-358845362,536870912,-804978046,449149634,805433442,-410709606,
		536870912,-648227976,421794259,553291775,-358845362,536870912,-804814587,445179530,805433442,-410709606,
		536870912,-638535076,415199499,553291775,-358845362,536870912,-804682366,441108661,805433442,-410709606,
		536870912,-628283611,408260731,553291775,-358845362,536870912,-804588922,436944970,805433442,-410709606,
		536870912,-617443767,400966491,553291775,-358845362,536870912,-804542980,432698181,805433442,-410709606,
		536870912,-605984517,393306224,553291775,-358845362,536870912,-804554597,428380004,805433442,-410709606,
		536870912,-593873639,385270608,553291775,-358845362,536870912,-804635321,424004349,805433442,-410709606,
		536870912,-581077741,376851931,553291775,-358845362,536870912,-804798354,419587565,805433442,-410709606,
		536870912,-567562308,368044539,553291775,-358845362,536870912,-805058723,415148671,805433442,-410709606,
		536870912,0,0,0,0,536870912,0,0,0,0,
		536870912,-538229636,349254520,553291775,-358845362,536870912,-805941668,406295462,805433442,-410709606,
		536870912,-522338600,339276034,553291775,-358845362,536870912,-806604829,401934712,805433442,-410709606,
		536870912,-505580810,328918630,553291775,-358845362,536870912,-807446703,397659395,805433442,-410709606,
		536870912,-487918156,318196647,553291775,-358845362,536870912,-808493431,393505246,805433442,-410709606,
		536870912,-469312698,307131047,553291775,-358845362,536870912,-809773429,389511739,805433442,-410709606,
		536870912,-449727245,295750509,553291775,-358845362,536870912,-811317155,385721989,805433442,-410709606,
		536870912,-429126130,284092575,553291775,-358845362,536870912,-813156677,382182471,805433442,-410709606,
		536870912,-407476226,272204789,553291775,-358845362,536870912,-815325008,378942487,805433442,-410709606,
		536870912,-384748252,260145757,553291775,-358845362,536870912,-817855137,376053312,805433442,-410709606,
		536870912,-360918390,247985987,553291775,-358845362,536870912,-820778725,373566954,805433442,-410709606,
		/* 10000Hz band*/
		536870912,56137600,356573763,-186040984,-268643972,536870912,-308325181,365412106,400006857,-289423789,
		536870912,66859881,348331346,-186040984,-268643972,536870912,-315840368,358022248,400006857,-289423789,
		536870912,78043739,339888202,-186040984,-268643972,536870912,-323680563,350500448,400006857,-289423789,
		536870912,89704048,331264755,-186040984,-268643972,536870912,-331859397,342870461,400006857,-289423789,
		536870912,101856225,322485920,-186040984,-268643972,536870912,-340391653,335160295,400006857,-289423789,
		536870912,114516296,313581626,-186040984,-268643972,536870912,-349293399,327402635,400006857,-289423789,
		536870912,127700950,304587350,-186040984,-268643972,536870912,-358582105,319635259,400006857,-289423789,
		536870912,141427550,295544661,-186040984,-268643972,536870912,-368276716,311901446,400006857,-289423789,
		536870912,155714083,286501754,-186040984,-268643972,536870912,-378397657,304250342,400006857,-289423789,
		536870912,170579014,277513928,-186040984,-268643972,536870912,-388966730,296737248,400006857,-289423789,
		536870912,0,0,0,0,536870912,0,0,0,0,
		536870912,202118319,259962391,-186040984,-268643972,536870912,-411541607,282377885,400006857,-289423789,
		536870912,218828269,251547373,-186040984,-268643972,536870912,-423594452,275673438,400006857,-289423789,
		536870912,236185918,243484394,-186040984,-268643972,536870912,-436187674,269389640,400006857,-289423789,
		536870912,254202736,235865332,-186040984,-268643972,536870912,-449340898,263609786,400006857,-289423789,
		536870912,272884725,228786949,-186040984,-268643972,536870912,-463069201,258419473,400006857,-289423789,
		536870912,292230230,222348621,-186040984,-268643972,536870912,-477380872,253904119,400006857,-289423789,
		536870912,312227524,216649274,-186040984,-268643972,536870912,-492274924,250145790,400006857,-289423789,
		536870912,332852407,211783540,-186040984,-268643972,536870912,-507738604,247219429,400006857,-289423789,
		536870912,354066129,207837353,-186040984,-268643972,536870912,-523745218,245188748,400006857,-289423789,
		536870912,375814044,204883326,-186040984,-268643972,536870912,-540252661,244102159,400006857,-289423789,

};
/*******************************************************************************
 *******************************************************************************
                        GLOBAL FUNCTION DEFINITIONS
 *******************************************************************************
 ******************************************************************************/

/**
 * @brief Initialize EQ.
 * 
 */
void initEqualizer(void)
{
	// Inicializar los filtros BIQUAD

        arm_biquad_cas_df1_32x64_init_q31(Low_Filters[0], NUMBER_OF_STAGES,
            (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*0 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
            &biquadStateBandQ63[0][0], 2);

        arm_biquad_cas_df1_32x64_init_q31(Low_Filters[1], NUMBER_OF_STAGES,
            (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*1 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
            &biquadStateBandQ63[1][0], 2);

         arm_biquad_cascade_df1_init_q31(High_Filters[0], NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*2 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[0][0], 2);

        arm_biquad_cascade_df1_init_q31(High_Filters[1], NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*3 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[1][0], 2);

         arm_biquad_cascade_df1_init_q31(High_Filters[2], NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*4 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[2][0], 2);

        arm_biquad_cascade_df1_init_q31(High_Filters[3], NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*5 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[3][0], 2);

         arm_biquad_cascade_df1_init_q31(High_Filters[4], NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*6 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[4][0], 2);

        arm_biquad_cascade_df1_init_q31(High_Filters[5], NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*7 + COEF_PER_FILTER*(DEFAULT_GAIN + MAX_GAIN)],
          &biquadStateBandQ31[5][0], 2);
}


/**
 * @brief Sets  equalizer filter gains.
 * @param gain  number in dB with the desired gain of the filter
 * @param band selected band in which to change gain (between 1 and NUMBER_OF_BANDS)
 */
void EQ_Set_Band_Gain (int32_t band, int32_t gain)
{
    if(band < 3 )
    {
         arm_biquad_cas_df1_32x64_init_q31(Low_Filters[band - 1], NUMBER_OF_STAGES,
            (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*(band-1) + COEF_PER_FILTER*(gain + MAX_GAIN)],
            &biquadStateBandQ63[band - 1][0], 2);
    }
    else
    {
         arm_biquad_cascade_df1_init_q31(High_Filters[band - 3], NUMBER_OF_STAGES,
          (q31_t *) &coeffTable[COEF_PER_FILTER*GAIN_LEVELS*(band-1) + COEF_PER_FILTER*(gain + MAX_GAIN)],
          &biquadStateBandQ31[band - 3][0], 2);
    }
	bandGains[band-1] = gain;
}


/**
 * @brief returns equalizer filter gains.
 * @return gain  number in dB 
 * @param band selected band in which to change gain (between 1 and NUMBER_OF_BANDS)
 */
int32_t EQ_Get_Band_Gain (int32_t band)
{
	return bandGains[band-1];
}

/**
 * @brief Applies the filter to the data in inputF32 and stores the result in outputF32
 * @param inputF32  pointer to an array of size FRAME_SIZE with input data
 * @param outputF32 pointer to an array of size FRAME_SIZE //!(will be overwritten)
 */
void EQ_Apply(float32_t* inputF32, float32_t * outputF32)
{
    
    /* ----------------------------------------------------------------------
    ** Q31 input and output buffers
    ** ------------------------------------------------------------------- */

    q31_t inputQ31[BLOCKSIZE];
    q31_t outputQ31[BLOCKSIZE];

    for(int i=0; i < NUMBER_OF_BLOCKS; i++)
    {

    /* ----------------------------------------------------------------------
    ** Convert block of input data from float to Q31
    ** ------------------------------------------------------------------- */

    arm_float_to_q31(inputF32 + (i*BLOCKSIZE), inputQ31, BLOCKSIZE);

    /* ----------------------------------------------------------------------
    ** Scale down by 1/8.  This provides additional headroom so that the
    ** graphic EQ can apply gain.
    ** ------------------------------------------------------------------- */

    arm_scale_q31(inputQ31, 0x7FFFFFFF, -3, inputQ31, BLOCKSIZE);

    /* ----------------------------------------------------------------------
    ** Call the Q31 Biquad Cascade DF1 32x64 process function for band1, band2
    ** ------------------------------------------------------------------- */
    arm_biquad_cas_df1_32x64_q31(&S1, inputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cas_df1_32x64_q31(&S2, outputQ31, outputQ31, BLOCKSIZE);
    /* ----------------------------------------------------------------------
    ** Call the Q31 Biquad Cascade DF1 process function for band3, band4, band5, band6, band7, band8
    ** ------------------------------------------------------------------- */
    arm_biquad_cascade_df1_fast_q31(&S3, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S4, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S5, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S6, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S7, outputQ31, outputQ31, BLOCKSIZE);
    arm_biquad_cascade_df1_fast_q31(&S8, outputQ31, outputQ31, BLOCKSIZE);
    /* ----------------------------------------------------------------------
    ** Convert Q31 result back to float
    ** ------------------------------------------------------------------- */

    arm_q31_to_float(outputQ31, outputF32 + (i * BLOCKSIZE), BLOCKSIZE);

    /* ----------------------------------------------------------------------
    ** Scale back up
    ** ------------------------------------------------------------------- */

    arm_scale_f32(outputF32 + (i * BLOCKSIZE), 8.0f, outputF32 + (i * BLOCKSIZE), BLOCKSIZE);
  };
}
